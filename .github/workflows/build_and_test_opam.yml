name: Build opam

# For any push we try to build the project with opam
# When a PR is open we do more test such as test more os and more ocaml versions
on: [push,pull_request]

jobs:

################################################################################
# Ubuntu
################################################################################
  install_ubuntu:
    # Basic test to check if the project build with opam.
    # If this test fails, no more building test with opam and non-regression are done
    name: Install Ubuntu

    strategy:
      matrix:
        # Setup the main ocaml version and os to test
        ocaml-version:
          - 4.10.0
        os:
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Retrieve opam cache
        uses: actions/cache@v2
        id: cache-opam
        with:
          path: ~/.opam
          key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

      - name: Use OCaml ${{ matrix.ocaml-version }}
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: ${{ matrix.ocaml-version }}

      - name: Set git user
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions-bot@users.noreply.github.com

      - name: Pin no action
        run: opam pin add . -y --no-action

      - name: Install depext
        run: opam depext -y alt-ergo-lib alt-ergo-parsers alt-ergo altgr-ergo
        # if: steps.cache-opam.outputs.cache-hit != 'true'

      - name: Install deps
        run: opam install -y ./*.opam --deps-only --with-test
        if: steps.cache-opam.outputs.cache-hit != 'true'

      - name: Fixup
        run: opam upgrade --fixup
        if: steps.cache-opam.outputs.cache-hit == 'true'

      - name: Install
        run: opam install .

  tests_ubuntu:
    name: Tests Ubuntu

    needs:
      - install_ubuntu

    strategy:
      matrix:
        # Setup the main ocaml version and os to test
        ocaml-version:
          - 4.10.0
        os:
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Retrieve opam cache
        uses: actions/cache@v2
        id: cache-opam
        with:
          path: ~/.opam
          key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

      - name: Use OCaml ${{ matrix.ocaml-version }}
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: ${{ matrix.ocaml-version }}

      - name: Run non regression tests
        run: opam exec -- rsc/extra/non_regression.sh


################################################################################
# Macos
################################################################################
  install_macos:
    # Test to install all package on mac with opam
    name: Install MacOS

    if: github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

    needs:
      - tests_ubuntu

    strategy:
      matrix:
        # Setup the main ocaml version to test
        ocaml-version:
          - 4.10.0
        os:
          - macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Retrieve opam cache
        uses: actions/cache@v2
        id: cache-opam
        with:
          path: ~/.opam
          key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

      - name: Use OCaml ${{ matrix.ocaml-version }}
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: ${{ matrix.ocaml-version }}

      - name: Set git user
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions-bot@users.noreply.github.com

      - name: Pin no actio
        run: opam pin add . -y --no-action

      - name: Install depext
        run: opam depext -y alt-ergo-lib alt-ergo-parsers alt-ergo altgr-ergo
        # if: steps.cache-opam.outputs.cache-hit != 'true'

      - name: Install deps
        run: opam install -y ./*.opam --deps-only --with-test
        if: steps.cache-opam.outputs.cache-hit != 'true'

      - name: Fixup
        run: opam upgrade --fixup
        if: steps.cache-opam.outputs.cache-hit == 'true'

      - name: Install
        run: opam install .

  tests_macos:
    name: Tests MacOS

    if: github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

    needs:
      - install_macos

    strategy:
      matrix:
        # Setup the main ocaml version to test
        ocaml-version:
          - 4.10.0
        os:
          - macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Retrieve opam cache
        uses: actions/cache@v2
        id: cache-opam
        with:
          path: ~/.opam
          key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

      - name: Use OCaml ${{ matrix.ocaml-version }}
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: ${{ matrix.ocaml-version }}

      - name: Run non regression tests
        run: opam exec -- rsc/extra/non_regression.sh

################################################################################
# Windows
################################################################################
  # install_windows:
  #   # Test to install all package on different os with opam
  #   name: Install Windows

  #   if: github.event_name == 'pull_request' || github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

  #   needs:
  #     - tests_ubuntu

  #   strategy:
  #     matrix:
  #       # Setup the main ocaml version to test
  #       ocaml-version:
  #         - 4.10.0
  #       os:
  #         - windows-latest

  #   runs-on: ${{ matrix.os }}

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v2

  #     - name: Retrieve opam cache
  #       uses: actions/cache@v2
  #       id: cache-opam
  #       with:
  #         path: ~/.opam
  #         key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

  #     - name: Use OCaml ${{ matrix.ocaml-version }}
  #       uses: avsm/setup-ocaml@v1
  #       with:
  #         ocaml-version: ${{ matrix.ocaml-version }}

  #     - name: Set git user
  #       run: |
  #         git config --global user.name github-actions
  #         git config --global user.email github-actions-bot@users.noreply.github.com

  #     - name: Pin no actio
  #       run: opam pin add . -y --no-action

  #     - name: Install depext
  #       run: opam depext -y alt-ergo-lib alt-ergo-parsers alt-ergo altgr-ergo
  #       # if: steps.cache-opam.outputs.cache-hit != 'true'

  #     - name: Install deps
  #       run: opam install -y ./*.opam --deps-only --with-test
  #       if: steps.cache-opam.outputs.cache-hit != 'true'

  #     - name: Fixup
  #       run: opam upgrade --fixup
  #       if: steps.cache-opam.outputs.cache-hit == 'true'

  #     - name: Install
  #       run: opam install .

  # tests_windows:
  #   name: Tests Windows

  #   # Only if in pull request
  #   if: github.event_name == 'pull_request'

  #   needs:
  #     - install_windows

  #   strategy:
  #     matrix:
  #       # Setup the main ocaml version to test
  #       ocaml-version:
  #         - 4.10.0
  #       os:
  #         - windows-latest

  #   runs-on: ${{ matrix.os }}

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v2

  #     - name: Retrieve opam cache
  #       uses: actions/cache@v2
  #       id: cache-opam
  #       with:
  #         path: ~/.opam
  #         key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

  #     - name: Use OCaml ${{ matrix.ocaml-version }}
  #       uses: avsm/setup-ocaml@v1
  #       with:
  #         ocaml-version: ${{ matrix.ocaml-version }}

  #     - name: Set git user
  #       run: |
  #         git config --global user.name github-actions
  #         git config --global user.email github-actions-bot@users.noreply.github.com

  #     - name: Pin no actio
  #       run: opam pin add . -y --no-action

  #     - name: Install depext
  #       run: opam depext -y alt-ergo-lib alt-ergo-parsers alt-ergo altgr-ergo
  #       if: steps.cache-opam.outputs.cache-hit != 'true'

  #     - name: Install deps
  #       run: opam install -y ./*.opam --deps-only --with-test
  #       if: steps.cache-opam.outputs.cache-hit != 'true'

  #     - name: Fixup
  #       run: opam upgrade --fixup
  #       if: steps.cache-opam.outputs.cache-hit == 'true'

  #     - name: Install
  #       run: opam install .

  #     - name: Convert non-regression script to dos
  #       run: |
  #         dos2unix rsc/extra/non_regression.sh
  #         dos2unix non-regression/*.sh

  #     - name: Run non regression tests
  #       run: opam exec -- rsc/extra/non_regression.sh

################################################################################
# OCaml versions
################################################################################
  install_ocaml_versions:
    # Test different versions of OCaml
    name: Install OCaml versions

    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

    needs:
      - tests_ubuntu

    strategy:
      matrix:
        # Setup ocaml versions and os to test
        os:
          - ubuntu-latest
        ocaml-version:
          - 4.04.2
          - 4.05.0
          - 4.06.1
          - 4.07.1
          - 4.08.1
          - 4.09.1
        cache-name:
          - opam-versions

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Retrieve opam cache
        uses: actions/cache@v2
        id: cache-opam
        with:
          path: ~/.opam
          key: v1-${{ runner.os }}-alt-ergo-${{ matrix.cache-name }}-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

      - name: Use OCaml ${{ matrix.ocaml-version }}
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: ${{ matrix.ocaml-version }}

      - name: Set git user
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions-bot@users.noreply.github.com

      - name: Pin no action
        run: opam pin add . -y --no-action

      - name: Install depext
        run: opam depext -y alt-ergo-lib alt-ergo-parsers alt-ergo altgr-ergo
        # if: steps.cache-opam.outputs.cache-hit != 'true'

      - name: Install deps
        run: opam install -y ./*.opam --deps-only --with-test
        if: steps.cache-opam.outputs.cache-hit != 'true'

      - name: Fixup
        run: opam upgrade --fixup
        if: steps.cache-opam.outputs.cache-hit == 'true'

      - name: Install
        run: opam install .

  tests_ocaml_versions:
    name: Tests OCaml versions

    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

    needs:
      - install_ocaml_versions

    strategy:
      matrix:
        os:
          - ubuntu-latest
        ocaml-version:
          - 4.04.2
          - 4.05.0
          - 4.06.1
          - 4.07.1
          - 4.08.1
          - 4.09.1
        cache-name:
          # use caches name of opam_ocaml_versions build workflow with alt-ergo
          # already installed for all ocaml supported versions
          - opam-versions

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Retrieve opam cache
        uses: actions/cache@v2
        id: cache-opam
        with:
          path: ~/.opam
          key: v1-${{ runner.os }}-alt-ergo-${{ matrix.cache-name }}-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

      - name: Use OCaml ${{ matrix.ocaml-version }}
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: ${{ matrix.ocaml-version }}

      - name: Run non regression tests
        run: opam exec -- rsc/extra/non_regression.sh


################################################################################
# Upload
################################################################################
  upload_ubuntu:
    name: Upload Ubuntu

    if: github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

    needs:
      - tests_ubuntu

    strategy:
      matrix:
        # Setup the main ocaml version and os to test
        ocaml-version:
          - 4.10.0
        os:
          - ubuntu-latest
        cache-name:
          - opam-all

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Retrieve opam cache
        uses: actions/cache@v2
        id: cache-opam
        with:
          path: ~/.opam
          key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

      - name: Use OCaml ${{ matrix.ocaml-version }}
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: ${{ matrix.ocaml-version }}

      - name: Get version and path
        id: get_version_path
        if: github.event_name == 'pull_request' || github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'
        run: |
          echo "::set-output name=version::$(opam exec -- alt-ergo --version)"
          echo "::set-output name=path::$(opam var bin)"

      # Upload Alt-Ergo binary if actions is triggered on next or in a PR
      - name: Upload Alt-Ergo binary
        uses: actions/upload-artifact@v2
        if: github.event_name == 'pull_request' || github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'
        with:
          name: alt-ergo-${{ steps.get_version_path.outputs.version }}-${{ runner.os }}-${{ matrix.ocaml-version }}
          path: "${{ steps.get_version_path.outputs.path }}/alt-ergo"

  # upload_windows:
  #   name: Upload Windows

  #   if: github.event_name == 'pull_request' || github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

  #   needs:
  #     - install_windows

  #   strategy:
  #     matrix:
  #       # Setup the main ocaml version to test
  #       ocaml-version:
  #         - 4.10.0
  #       os:
  #         - windows-latest

  #   runs-on: ${{ matrix.os }}

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v2

  #     - name: Retrieve opam cache
  #       uses: actions/cache@v2
  #       id: cache-opam
  #       with:
  #         path: ~/.opam
  #         key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

  #     - name: Use OCaml ${{ matrix.ocaml-version }}
  #       uses: avsm/setup-ocaml@v1
  #       with:
  #         ocaml-version: ${{ matrix.ocaml-version }}

  #     - name: Get version and path
  #       id: get_version_path
  #       run: |
  #         echo "::set-output name=version::$(opam exec -- alt-ergo --version)"
  #         echo "::set-output name=path::$(opam var bin)"

  #     - name: Upload Alt-Ergo binary
  #       uses: actions/upload-artifact@v2
  #       with:
  #         name: alt-ergo-${{ steps.get_version_path.outputs.version }}-${{ runner.os }}-${{ matrix.ocaml-version }}
  #         path: "${{ steps.get_version_path.outputs.path }}\alt-ergo"


  upload_macos:
    # Test to install all package on mac with opam
    name: Upload MacOS

    if: github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

    needs:
      - install_macos

    strategy:
      matrix:
        # Setup the main ocaml version to test
        ocaml-version:
          - 4.10.0
        os:
          - macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Retrieve opam cache
        uses: actions/cache@v2
        id: cache-opam
        with:
          path: ~/.opam
          key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

      - name: Use OCaml ${{ matrix.ocaml-version }}
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: ${{ matrix.ocaml-version }}

      - name: Get version and path
        id: get_version_path
        run: |
          echo "::set-output name=version::$(opam exec -- alt-ergo --version)"
          echo "::set-output name=path::$(opam var bin)"

      # Upload Alt-Ergo binary if actions is triggered on next or in a PR
      - name: Upload Alt-Ergo binary
        uses: actions/upload-artifact@v2
        with:
          name: alt-ergo-${{ steps.get_version_path.outputs.version }}-${{ runner.os }}-${{ matrix.ocaml-version }}
          path: "${{ steps.get_version_path.outputs.path }}/alt-ergo"


# All windows, windows cache is buggy so we use only on job to do everything
  all_windows:
    name: All Windows

    if: github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

    needs:
      - tests_ubuntu

    strategy:
      matrix:
        # Setup the main ocaml version to test
        ocaml-version:
          - 4.10.0
        os:
          - windows-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Retrieve opam cache
        uses: actions/cache@v2
        id: cache-opam
        with:
          path: ~/.opam
          key: v1-${{ runner.os }}-alt-ergo-${{ matrix.ocaml-version }}-${{ hashFiles('*.opam') }}

      - name: Use OCaml ${{ matrix.ocaml-version }}
        uses: avsm/setup-ocaml@v1
        with:
          ocaml-version: ${{ matrix.ocaml-version }}

      - name: Set git user
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions-bot@users.noreply.github.com

      - name: Pin no actio
        run: opam pin add . -y --no-action

      - name: Install depext
        run: opam depext -y alt-ergo-lib alt-ergo-parsers alt-ergo altgr-ergo
        if: steps.cache-opam.outputs.cache-hit != 'true'

      - name: Install deps
        run: opam install -y ./*.opam --deps-only --with-test
        if: steps.cache-opam.outputs.cache-hit != 'true'

      - name: Fixup
        run: opam upgrade --fixup
        if: steps.cache-opam.outputs.cache-hit == 'true'

      - name: Install
        run: opam install .

      - name: Get version and path
        id: get_version_path
        run: |
          echo "::set-output name=version::$(opam exec -- alt-ergo --version)"
          echo "::set-output name=path::$(opam var bin)"
        if: github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

      - name: Upload Alt-Ergo binary
        uses: actions/upload-artifact@v2
        with:
          name: alt-ergo-${{ steps.get_version_path.outputs.version }}-${{ runner.os }}-${{ matrix.ocaml-version }}
          path: "${{ steps.get_version_path.outputs.path }}\\alt-ergo"
        if: github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main'

      - name: Convert non-regression script to dos
        run: |
          dos2unix rsc/extra/non_regression.sh
          dos2unix non-regression/*.sh

      - name: Run non regression tests
        run: opam exec -- rsc/extra/non_regression.sh
